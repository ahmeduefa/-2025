<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>القطاعات الصحية التابعة لفرع وزارة الصحة بمنطقة عسير</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Global Styles & Variables */
        :root {
            --moh-green: #007e3a;
            --moh-light-green: #e0f2e6;
            --moh-dark-green: #00612d;
            --moh-gold: #d4af37;
            --moh-white: #ffffff;
            --moh-light-gray: #f5f5f5;
            --moh-text: #333333;
            --moh-blue: #1a73e8;
            --moh-red: #ea4335;
            --moh-purple: #8e44ad;
            --moh-orange: #f39c12;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--moh-light-gray);
            color: var(--moh-text);
            padding: 15px;
            line-height: 1.6;
            overflow-x: hidden;
        }
        
        /* Utility Classes */
        .flex-center {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Layout */
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            background: linear-gradient(135deg, var(--moh-green), var(--moh-dark-green));
            color: var(--moh-white);
            padding: 25px;
            border-radius: 16px;
            margin-bottom: 25px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
            text-align: center;
        }

        .logo-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            margin-bottom: 15px;
        }

        .logo {
            width: 80px;
            height: 80px;
            background-color: var(--moh-white);
            border-radius: 50%;
            font-size: 36px;
            color: var(--moh-green);
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
            animation: pulse 2s infinite;
        }

        h1 {
            font-size: 2.2rem;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        p.subtitle {
            font-size: 1.1rem;
            opacity: 0.95;
            max-width: 800px;
            margin: 0 auto;
        }

        .dashboard {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
            margin-bottom: 30px;
        }

        /* Card Component */
        .card, .user-location-section, .filters {
            background: var(--moh-white);
            border-radius: 16px;
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(0, 126, 58, 0.1);
        }
        
        .card {
            overflow: hidden;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .card:hover {
            transform: translateY(-8px);
            box-shadow: 0 12px 25px rgba(0, 0, 0, 0.15);
        }

        .card-header {
            background: linear-gradient(135deg, var(--moh-green), var(--moh-dark-green));
            color: var(--moh-white);
            padding: 18px 25px;
            font-size: 1.3rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .card-body {
            padding: 25px;
            height: 450px;
        }

        /* Stats Section */
        .stats-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            height: 100%;
            overflow-y: auto;
            padding: 5px;
        }

        .stat-card {
            color: var(--moh-white);
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 140px;
        }
        
        .stat-card:nth-child(1) { background: linear-gradient(135deg, var(--moh-green), var(--moh-dark-green)); }
        .stat-card:nth-child(2) { background: linear-gradient(135deg, var(--moh-blue), #0d5bb9); }
        .stat-card:nth-child(3) { background: linear-gradient(135deg, var(--moh-red), #d23c30); }
        .stat-card:nth-child(4) { background: linear-gradient(135deg, var(--moh-purple), #7d3c98); }
        .stat-card:nth-child(5) { background: linear-gradient(135deg, var(--moh-orange), #e67e22); }
        .stat-card:nth-child(6) { background: linear-gradient(135deg, #16a085, #1abc9c); }
        
        .stat-card:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
        }

        .stat-icon {
            font-size: 2.2rem;
            margin-bottom: 12px;
            background: rgba(255, 255, 255, 0.2);
            width: 70px;
            height: 70px;
            border-radius: 50%;
            transition: transform 0.3s cubic-bezier(0.68, -0.55, 0.27, 1.55);
        }
        
        .stat-card:hover .stat-icon {
            transform: rotate(15deg) scale(1.1);
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 8px;
            min-height: 40px;
        }
        .stat-label { font-size: 1rem; opacity: 0.95; }


        /* User Location Section */
        .user-location-section {
            padding: 25px;
            margin-bottom: 30px;
        }
        .user-location-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
            color: var(--moh-green);
            font-size: 1.4rem;
        }
        .user-location-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
        }
        .location-info, .closest-hospital-info {
            padding: 20px;
            background-color: var(--moh-light-green);
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        /* Map */
        .map-container, #hospitals-map { height: 100%; width: 100%; }
        #hospitals-map { border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .map-marker {
            width: 35px;
            height: 35px;
            border-radius: 50% 50% 50% 0;
            transform: rotate(-45deg);
            box-shadow: 0 3px 8px rgba(0,0,0,0.4);
            border: 2px solid white;
        }
        .map-marker i {
            transform: rotate(45deg);
            font-size: 16px;
            color: white;
        }
        .legend { padding: 15px; background: white; border-radius: 8px; box-shadow: 0 3px 10px rgba(0,0,0,0.4); }
        .legend i { width: 20px; height: 20px; float: right; margin-left: 10px; border-radius: 50%; }

        /* Table & Filters */
        .filters {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
            flex-wrap: wrap;
            padding: 20px;
        }

        select, input[type="text"] {
            padding: 12px 15px;
            border-radius: 8px;
            border: 1px solid #ddd;
            min-width: 180px;
            flex: 1;
            font-size: 1rem;
            transition: border-color 0.3s, box-shadow 0.3s;
        }
        select:focus, input[type="text"]:focus {
            border-color: var(--moh-green);
            box-shadow: 0 0 0 3px rgba(0, 126, 58, 0.2);
            outline: none;
        }

        .table-container {
            overflow-x: auto;
            border-radius: 12px;
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1);
            background: var(--moh-white);
        }
        table { width: 100%; border-collapse: collapse; min-width: 800px; }
        th, td { padding: 15px 18px; text-align: right; border-bottom: 1px solid #e0e0e0; }
        th {
            background: linear-gradient(135deg, var(--moh-green), var(--moh-dark-green));
            color: var(--moh-white);
            font-weight: bold;
            position: sticky;
            top: 0;
            z-index: 2;
        }
        tr:hover { background-color: var(--moh-light-green); }

        /* Buttons */
        .btn {
            border: none;
            color: var(--moh-white);
            padding: 12px 18px;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.3s, transform 0.2s, box-shadow 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            font-size: 1rem;
            text-decoration: none;
            font-weight: 600;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .btn:hover { transform: translateY(-3px); box-shadow: 0 4px 8px rgba(0,0,0,0.15); }
        .btn:active { transform: translateY(0) scale(0.98); box-shadow: 0 1px 4px rgba(0, 0, 0, 0.1); }
        
        .btn-primary { background: var(--moh-green); }
        .btn-primary:hover { background: var(--moh-dark-green); }

        .btn-secondary { background: var(--moh-gold); color: var(--moh-dark-green); }
        .btn-secondary:hover { background: #c09e2e; }

        .details-btn {
            background: var(--moh-green);
            padding: 8px 12px;
            gap: 5px;
        }
        .details-btn:hover {
             background: var(--moh-dark-green);
             transform: translateY(-2px) scale(1.05);
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.6);
            z-index: 1000;
            backdrop-filter: blur(5px);
        }
        .modal-content {
            background-color: var(--moh-white);
            padding: 30px 35px;
            border-radius: 16px;
            width: 90%;
            max-width: 700px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.25);
            animation: scaleIn 0.4s ease-out;
            margin: auto; /* for vertical and horizontal centering */
        }
        .modal.closing .modal-content { animation: scaleOut 0.3s ease-in forwards; }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 18px;
            border-bottom: 2px solid var(--moh-light-green);
        }
        .modal-title { font-size: 1.8rem; color: var(--moh-dark-green); font-weight: 700; }
        .close-btn {
            background: #f1f1f1;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #555;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            transition: all 0.3s;
        }
        .close-btn:hover { background: #e0e0e0; color: black; transform: rotate(90deg); }
        .detail-group { margin-bottom: 25px; }
        .detail-group-title {
            font-weight: bold;
            color: var(--moh-green);
            margin-bottom: 15px;
            border-bottom: 2px solid var(--moh-light-green);
            padding-bottom: 8px;
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .detail-item {
            display: grid; 
            grid-template-columns: 1fr 2fr;
            align-items: center;
            font-size: 1.1rem;
            padding: 10px 15px;
            background: var(--moh-light-gray);
            border-radius: 8px;
            margin-bottom: 10px;
            gap: 15px;
        }
        .detail-label { font-weight: bold; color: #555; }
        .action-buttons { display: flex; gap: 15px; margin-top: 30px; flex-wrap: wrap; }
        
        /* Loader & Notifications */
        .loader { height: 200px; flex-direction: column; gap: 20px; }
        .loading {
            width: 30px;
            height: 30px;
            border: 4px solid rgba(0, 126, 58, 0.3);
            border-radius: 50%;
            border-top-color: var(--moh-green);
            animation: spin 1s ease-in-out infinite;
        }
        .notification {
            position: fixed;
            bottom: 25px;
            right: 25px;
            padding: 18px 25px;
            color: white;
            border-radius: 10px;
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.2);
            transform: translateY(120%);
            opacity: 0;
            transition: transform 0.4s, opacity 0.4s;
            z-index: 2000;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .notification.show { transform: translateY(0); opacity: 1; }
        .notification.success { background-color: var(--moh-green); }
        .notification.error { background-color: var(--moh-red); }

        /* Back to Top Button */
        .back-to-top {
            position: fixed;
            bottom: 35px;
            left: 35px;
            width: 60px;
            height: 60px;
            background-color: var(--moh-green);
            color: white;
            border-radius: 50%;
            font-size: 24px;
            cursor: pointer;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            z-index: 999;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        .back-to-top.visible { opacity: 1; visibility: visible; }
        .back-to-top:hover { transform: translateY(-5px); }

        /* Footer */
        footer { text-align: center; padding: 25px; margin-top: 50px; color: var(--moh-green); border-top: 1px solid rgba(0, 126, 58, 0.2); }

        /* Animations */
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
        @keyframes spin { to { transform: rotate(360deg); } }
        @keyframes scaleIn { from { transform: scale(0.8) translateY(20px); opacity: 0; } to { transform: scale(1) translateY(0); opacity: 1; } }
        @keyframes scaleOut { from { transform: scale(1); opacity: 1; } to { transform: scale(0.8); opacity: 0; } }
        .animate-on-scroll { opacity: 0; transform: translateY(30px); transition: opacity 0.6s ease-out, transform 0.6s ease-out; }
        .animate-on-scroll.visible { opacity: 1; transform: translateY(0); }
        tbody tr { opacity: 0; transform: translateY(10px); transition: opacity 0.4s ease-out, transform 0.4s ease-out; }
        tbody tr.visible { opacity: 1; transform: translateY(0); }

        /* Media Queries */
        @media (max-width: 992px) {
            .dashboard { grid-template-columns: 1fr; }
            h1 { font-size: 1.8rem; }
        }
        @media (max-width: 768px) {
            body { padding: 10px; }
            .user-location-content { grid-template-columns: 1fr; }
            .filters { flex-direction: column; }
            .card-body { height: 400px; }
            .modal-content { padding: 20px; }
            /* Hide less critical columns on smaller screens */
            th:nth-child(7), td:nth-child(7), /* ICU beds */
            th:nth-child(8), td:nth-child(8)  /* Distance */
            { display: none; }
        }
        @media (max-width: 480px) {
            h1 { font-size: 1.5rem; }
            .logo { width: 60px; height: 60px; font-size: 28px;}
            .card-body { height: 350px; }
            .stats-container { grid-template-columns: 1fr; }
            .action-buttons { flex-direction: column; }
            .detail-item { grid-template-columns: 1fr; gap: 5px; }
             /* Hide more columns on smallest screens */
            th:nth-child(4), td:nth-child(4), /* Type */
            th:nth-child(5), td:nth-child(5)  /* Supervisor */
            { display: none; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo-container">
                <div class="logo flex-center"><i class="fas fa-hospital"></i></div>
                <div>
                    <h1>القطاعات الصحية التابعة لفرع وزارة الصحة بمنطقة عسير</h1>
                    <p class="subtitle">منصة متكاملة لعرض بيانات المستشفيات والمراكز الصحية في منطقة عسير</p>
                </div>
            </div>
        </header>

        <div class="user-location-section animate-on-scroll">
            <div class="user-location-header"><i class="fas fa-map-marker-alt"></i><h2>الموقع الحالي</h2></div>
            <div class="user-location-content">
                <div class="location-info">
                    <h3><i class="fas fa-location-dot"></i> موقعك الحالي</h3>
                    <div>خط العرض: <span id="current-lat">--</span></div>
                    <div>خط الطول: <span id="current-lng">--</span></div>
                    <div>الدقة: <span id="current-accuracy">--</span></div>
                    <button id="get-location-btn" class="btn btn-primary" style="margin-top:15px;"><i class="fas fa-location-crosshairs"></i> تحديث الموقع</button>
                </div>
                <div class="closest-hospital-info">
                    <h3><i class="fas fa-hospital"></i> مستشفى عسير المركزي</h3>
                    <div id="asir-hospital-info">
                        <div><strong>الموقع:</strong> أبها</div>
                        <div><strong>خط العرض:</strong> 18.2195</div>
                        <div><strong>خط الطول:</strong> 42.535</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="dashboard">
            <div class="card animate-on-scroll">
                <div class="card-header"><i class="fas fa-map-marked-alt"></i><span>الخريطة التفاعلية</span></div>
                <div class="card-body">
                    <div class="map-container">
                        <div id="hospitals-map"></div>
                    </div>
                </div>
            </div>
            <div class="card animate-on-scroll">
                <div class="card-header"><i class="fas fa-chart-bar"></i><span>إحصائيات عامة</span></div>
                <div class="card-body">
                    <div class="stats-container">
                        <div class="stat-card">
                            <div class="stat-icon flex-center"><i class="fas fa-hospital"></i></div>
                            <div class="stat-number" data-stat="total">0</div>
                            <div class="stat-label">عدد المستشفيات</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon flex-center"><i class="fas fa-bed"></i></div>
                            <div class="stat-number" data-stat="beds">0</div>
                            <div class="stat-label">إجمالي الأسرة</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon flex-center"><i class="fas fa-procedures"></i></div>
                            <div class="stat-number" data-stat="icu">0</div>
                            <div class="stat-label">أسرة العناية المركزة</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon flex-center"><i class="fas fa-stethoscope"></i></div>
                            <div class="stat-number" data-stat="private">0</div>
                            <div class="stat-label">مستشفى خاص</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon flex-center"><i class="fas fa-clinic-medical"></i></div>
                            <div class="stat-number" data-stat="general">0</div>
                            <div class="stat-label">مستشفيات عامة</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon flex-center"><i class="fas fa-heartbeat"></i></div>
                            <div class="stat-number" data-stat="specialized">0</div>
                            <div class="stat-label">مستشفيات متخصصة</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="data-section animate-on-scroll">
            <div class="filters">
                <select id="filter-type"><option value="">جميع الأنواع</option></select>
                <select id="filter-supervisor"><option value="">جميع الجهات المشرفة</option></select>
                <input type="text" id="search-input" placeholder="ابحث باسم المستشفى أو المحافظة...">
            </div>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>اسم المستشفى</th>
                            <th>المحافظة</th>
                            <th>النوع</th>
                            <th>الجهة المشرفة</th>
                            <th>عدد الأسرة</th>
                            <th>أسرة العناية</th>
                            <th>المسافة (كم)</th>
                            <th>التفاصيل</th>
                        </tr>
                    </thead>
                    <tbody id="hospitals-table">
                        <tr><td colspan="9"><div class="loader flex-center"><div class="loading"></div><span>جاري تحميل البيانات...</span></div></td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <footer><p>© 2024 وزارة الصحة - المملكة العربية السعودية. جميع الحقوق محفوظة.</p></footer>
    </div>

    <div class="back-to-top flex-center" id="back-to-top"><i class="fas fa-arrow-up"></i></div>

    <div class="modal flex-center" id="details-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modal-hospital-name"></h2>
                <button class="close-btn flex-center" id="close-modal-btn">×</button>
            </div>
            <div id="modal-content-body"></div>
            <div class="action-buttons">
                <a id="modal-google-maps-btn" class="btn btn-primary" target="_blank" rel="noopener noreferrer"><i class="fas fa-map-location-dot"></i> الانتقال للموقع على الخريطة</a>
            </div>
        </div>
    </div>

    <div class="notification" id="notification"><i id="notification-icon" class="fas"></i><span id="notification-text"></span></div>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            let hospitals = [];
            let currentHospital = null;
            let map;
            let hospitalMarkers = L.layerGroup();
            let userMarker;
            const ASIR_CENTRAL_HOSPITAL = { lat: 18.2195, lng: 42.535 };
            const DATA_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vR6OX3acZw-8gzNb36iUGra5OI-7TQmhEeZTxpoyyPO1kdYNlycokRPa4FWf9pY6CRRRu9fl0SHhBVZ/pub?gid=0&single=true&output=csv";
            
            const UI = {
                tableBody: document.getElementById('hospitals-table'),
                typeFilter: document.getElementById('filter-type'),
                supervisorFilter: document.getElementById('filter-supervisor'),
                searchInput: document.getElementById('search-input'),
                modal: document.getElementById('details-modal'),
                modalTitle: document.getElementById('modal-hospital-name'),
                modalBody: document.getElementById('modal-content-body'),
                modalMapsBtn: document.getElementById('modal-google-maps-btn'),
                notification: document.getElementById('notification'),
                notificationText: document.getElementById('notification-text'),
                notificationIcon: document.getElementById('notification-icon'),
                lat: document.getElementById('current-lat'),
                lng: document.getElementById('current-lng'),
                accuracy: document.getElementById('current-accuracy'),
                backToTop: document.getElementById('back-to-top'),
            };

            async function fetchData() {
                try {
                    const response = await fetch(DATA_URL, { cache: 'no-store' });
                    if (!response.ok) throw new Error(`Network error: ${response.statusText}`);
                    
                    const csvText = await response.text();
                    const results = Papa.parse(csvText, { header: true, skipEmptyLines: true, transformHeader: h => h.trim() });
                    
                    hospitals = results.data
                        .map((row, i) => ({
                            ...row,
                            id: i,
                            lat: parseFloat(row['Latitude']),
                            lng: parseFloat(row['Longitude']),
                            distanceFromAsir: haversine(parseFloat(row['Latitude']), parseFloat(row['Longitude']), ASIR_CENTRAL_HOSPITAL.lat, ASIR_CENTRAL_HOSPITAL.lng)
                        }))
                        .filter(h => !isNaN(h.lat) && !isNaN(h.lng) && h['أسم المستشفى']);
                    
                    if (hospitals.length === 0) throw new Error("No valid data found.");
                    
                    initializeApp();
                    showNotification(`تم تحميل ${hospitals.length} مستشفى بنجاح`, 'success');
                } catch (error) {
                    console.error("Fetch Data Error:", error);
                    UI.tableBody.innerHTML = `<tr><td colspan="9" style="text-align:center;">❌ فشل تحميل البيانات: ${error.message}</td></tr>`;
                    showNotification("فشل في جلب البيانات.", 'error');
                }
            }
            
            function initializeApp() {
                initMap();
                populateFilters();
                updateStats();
                renderTable(hospitals);
                addEventListeners();
                initIntersectionObserver();
            }

            function initMap() {
                map = L.map('hospitals-map');
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '© OpenStreetMap' }).addTo(map);

                // --- تحديد منطقة عسير ---
                const asirRegionCoords = [
                    [17.58, 41.8], [19.8, 41.7], [20.0, 42.5],
                    [19.3, 44.3], [18.0, 43.5], [17.4, 42.6]
                ];
                const asirPolygon = L.polygon(asirRegionCoords, {
                    color: 'var(--moh-dark-green)',
                    weight: 3,
                    fillColor: 'var(--moh-green)',
                    fillOpacity: 0.15
                }).addTo(map);
                
                // تركيز الخريطة على حدود منطقة عسير
                map.fitBounds(asirPolygon.getBounds());
                
                hospitalMarkers.addTo(map);
                renderMapMarkers(hospitals);
                addMapLegend();
            }
            
            function getMarkerStyle(type) {
                switch (type) {
                    case 'مستشفيات عامة': return { color: '#1a73e8', icon: 'fa-hospital' };
                    case 'مستشفيات متخصصة': return { color: '#ea4335', icon: 'fa-heartbeat' };
                    case 'مستشفى مركزي': return { color: '#007e3a', icon: 'fa-star-of-life' };
                    case 'مستشفى خاص': return { color: '#f39c12', icon: 'fa-stethoscope' };
                    default: return { color: '#808080', icon: 'fa-clinic-medical' };
                }
            }

            function createMarkerIcon(style) {
                return L.divIcon({
                    className: '',
                    html: `<div class="map-marker flex-center" style="background-color: ${style.color};"><i class="fas ${style.icon}"></i></div>`,
                    iconSize: [35, 35],
                    iconAnchor: [17, 35]
                });
            }

            function renderMapMarkers(data) {
                hospitalMarkers.clearLayers();
                data.forEach(h => {
                    const style = getMarkerStyle(h['نوع المستشفى']);
                    const icon = createMarkerIcon(style);
                    L.marker([h.lat, h.lng], { icon })
                        .bindPopup(`<b>${h['أسم المستشفى']}</b>`)
                        .on('click', () => showDetails(h.id))
                        .addTo(hospitalMarkers);
                });
            }
            
            function addMapLegend() {
                const legend = L.control({ position: 'bottomright' });
                legend.onAdd = function () {
                    const div = L.DomUtil.create('div', 'legend');
                    const types = ['مستشفيات عامة', 'مستشفيات متخصصة', 'مستشفى خاص', 'أخرى'];
                    div.innerHTML = '<h4>أنواع المستشفيات</h4>';
                    types.forEach(type => {
                        div.innerHTML += `<i style="background: ${getMarkerStyle(type).color}"></i> ${type}<br>`;
                    });
                    return div;
                };
                legend.addTo(map);
            }

            function populateFilters() {
                const types = [...new Set(hospitals.map(h => h['نوع المستشفى']))].filter(Boolean);
                const supervisors = [...new Set(hospitals.map(h => h['الجهة المشرفة']))].filter(Boolean);
                UI.typeFilter.innerHTML += types.map(t => `<option value="${t}">${t}</option>`).join('');
                UI.supervisorFilter.innerHTML += supervisors.map(s => `<option value="${s}">${s}</option>`).join('');
            }
            
            function renderTable(data) {
                if (!data.length) {
                    UI.tableBody.innerHTML = '<tr><td colspan="9" style="text-align:center;">لا توجد نتائج</td></tr>';
                    renderMapMarkers([]);
                    return;
                }
                UI.tableBody.innerHTML = data.map((h, i) => `
                    <tr>
                        <td>${i + 1}</td>
                        <td>${h['أسم المستشفى']}</td>
                        <td>${h['المحافظة'] || '--'}</td>
                        <td>${h['نوع المستشفى'] || '--'}</td>
                        <td>${h['الجهة المشرفة'] || '--'}</td>
                        <td>${h['عدد أسرة التنويم'] || '--'}</td>
                        <td>${h['عدد اسرة العناية المركزة كبار'] || '--'}</td>
                        <td>${h.distanceFromAsir ? h.distanceFromAsir.toFixed(1) : '--'}</td>
                        <td><button class="btn details-btn" data-id="${h.id}"><i class="fas fa-info-circle"></i> عرض</button></td>
                    </tr>`).join('');

                UI.tableBody.querySelectorAll('tr').forEach((row, index) => {
                    setTimeout(() => row.classList.add('visible'), index * 40);
                });

                renderMapMarkers(data);
            }

            function filterAndRender() {
                const type = UI.typeFilter.value;
                const supervisor = UI.supervisorFilter.value;
                const search = UI.searchInput.value.toLowerCase();
                
                const filtered = hospitals.filter(h =>
                    (!type || h['نوع المستشفى'] === type) &&
                    (!supervisor || h['الجهة المشرفة'] === supervisor) &&
                    ( (h['أسم المستشفى'] && h['أسم المستشفى'].toLowerCase().includes(search)) || 
                      (h['المحافظة'] && h['المحافظة'].toLowerCase().includes(search)) )
                );
                renderTable(filtered);
            }

            function openModal() {
                UI.modal.style.display = 'flex';
                document.body.style.overflow = 'hidden';
            }

            function closeModal() {
                UI.modal.classList.add('closing');
                setTimeout(() => {
                    UI.modal.style.display = 'none';
                    UI.modal.classList.remove('closing');
                    document.body.style.overflow = '';
                }, 300);
            }

            function showDetails(id) {
                const hospital = hospitals.find(h => h.id === id);
                if (!hospital) return;
                currentHospital = hospital;

                UI.modalTitle.textContent = hospital['أسم المستشفى'];
                
                const knownGroups = {
                    'بيانات عامة': { icon: 'fa-hospital', fields: ['المحافظة', 'نوع المستشفى', 'الجهة المشرفة', 'مدير المستشفى', 'ملكية المباني'] },
                    'إحصائيات الأسرة': { icon: 'fa-bed', fields: ['عدد أسرة التنويم', 'عدد اسرة العناية المركزة كبار', 'عدد اسرة العناية المركزة أطفال', 'عدد اسرة العناية المركزة حديثي الولادة', 'عدد أسرة العناية القلبية', 'عدد أسرة الطوارئ', 'عدد أسرة العزل'] },
                    'إحصائيات أخرى': { icon: 'fa-chart-pie', fields: ['عدد المستفيدين', 'عدد المراجعين', 'عدد الحالات الطارئة والإصابات', 'عدد العيادات', 'عدد سيارات الإسعاف المستلمة'] },
                };
                const allKnownFields = Object.values(knownGroups).flatMap(g => g.fields).concat(['id', 'lat', 'lng', 'Latitude', 'Longitude', 'أسم المستشفى', 'distanceFromAsir', 'موقع المنشأة في قوقل ماب']);

                let detailsHTML = '';
                
                for (const groupName in knownGroups) {
                    const group = knownGroups[groupName];
                    let groupContent = '';
                    group.fields.forEach(key => {
                        const value = hospital[key];
                        if (value && String(value).trim() && String(value).trim().toLowerCase() !== 'n/a') {
                            groupContent += `<div class="detail-item"><span class="detail-label">${key}</span><span>${value}</span></div>`;
                        }
                    });
                    if (groupContent) {
                        detailsHTML += `<div class="detail-group"><div class="detail-group-title"><i class="fas ${group.icon}"></i>${groupName}</div>${groupContent}</div>`;
                    }
                }
                
                let otherContent = '';
                for (const key in hospital) {
                    const value = hospital[key];
                    if (!allKnownFields.includes(key) && value && String(value).trim() && String(value).trim().toLowerCase() !== 'n/a') {
                         otherContent += `<div class="detail-item"><span class="detail-label">${key}</span><span>${value}</span></div>`;
                    }
                }
                
                if(otherContent) {
                    detailsHTML += `<div class="detail-group"><div class="detail-group-title"><i class="fas fa-info-circle"></i>بيانات إضافية</div>${otherContent}</div>`;
                }
                
                UI.modalBody.innerHTML = detailsHTML;
                
                const mapLink = hospital['موقع المنشأة في قوقل ماب'] || `https://maps.google.com/?q=${hospital.lat},${hospital.lng}`;
                UI.modalMapsBtn.href = mapLink;

                openModal();
            }

            function updateStats() {
                const stats = {
                    total: hospitals.length,
                    beds: hospitals.reduce((sum, h) => sum + (parseInt(h['عدد أسرة التنويم']) || 0), 0),
                    icu: hospitals.reduce((sum, h) => sum + (parseInt(h['عدد اسرة العناية المركزة كبار']) || 0), 0),
                    private: hospitals.filter(h => h['نوع المستشفى'] === "مستشفى خاص").length,
                    general: hospitals.filter(h => h['نوع المستشفى'] === "مستشفيات عامة").length,
                    specialized: hospitals.filter(h => h['نوع المستشفى'] === "مستشفيات متخصصة").length,
                };
                document.querySelectorAll('.stat-number').forEach(el => {
                    const statKey = el.dataset.stat;
                    if(stats.hasOwnProperty(statKey)) {
                       animateCounter(el, stats[statKey]);
                    }
                });
            }

            function animateCounter(el, end, duration = 1500) {
                let start = 0;
                const range = end - start;
                let startTime = null;
                const step = (timestamp) => {
                    if (!startTime) startTime = timestamp;
                    const progress = Math.min((timestamp - startTime) / duration, 1);
                    el.textContent = Math.floor(progress * range + start).toLocaleString();
                    if (progress < 1) window.requestAnimationFrame(step);
                };
                window.requestAnimationFrame(step);
            }

            function addEventListeners() {
                UI.typeFilter.addEventListener('change', filterAndRender);
                UI.supervisorFilter.addEventListener('change', filterAndRender);
                UI.searchInput.addEventListener('input', filterAndRender);
                document.getElementById('get-location-btn').addEventListener('click', getUserLocation);
                
                UI.tableBody.addEventListener('click', e => {
                    const btn = e.target.closest('.details-btn');
                    if (btn) showDetails(parseInt(btn.dataset.id));
                });
                
                document.getElementById('close-modal-btn').addEventListener('click', closeModal);
                UI.modal.addEventListener('click', e => {
                    if (e.target === UI.modal) closeModal();
                });
                
                UI.backToTop.addEventListener('click', () => window.scrollTo({ top: 0, behavior: 'smooth' }));
                window.addEventListener('scroll', () => {
                    UI.backToTop.classList.toggle('visible', window.scrollY > 300);
                });
            }

            function getUserLocation() {
                if (!navigator.geolocation) {
                    showNotification("متصفحك لا يدعم تحديد الموقع.", 'error');
                    return;
                }
                navigator.geolocation.getCurrentPosition(pos => {
                    const { latitude, longitude, accuracy } = pos.coords;
                    UI.lat.textContent = latitude.toFixed(5);
                    UI.lng.textContent = longitude.toFixed(5);
                    UI.accuracy.textContent = `${Math.round(accuracy)} م`;

                    if (userMarker) map.removeLayer(userMarker);
                    const userIcon = createMarkerIcon({ color: '#28a745', icon: 'fa-user' });
                    userMarker = L.marker([latitude, longitude], { icon: userIcon }).addTo(map);
                    map.setView([latitude, longitude], 13);
                    showNotification("تم تحديد موقعك بنجاح.", 'success');
                }, () => showNotification("لا يمكن الوصول لموقعك.", 'error'));
            }

            function haversine(lat1, lon1, lat2, lon2) {
                if (isNaN(lat1) || isNaN(lon1) || isNaN(lat2) || isNaN(lon2)) return null;
                const R = 6371;
                const dLat = (lat2 - lat1) * Math.PI / 180;
                const dLon = (lon2 - lon1) * Math.PI / 180;
                const a = Math.sin(dLat / 2) ** 2 + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon / 2) ** 2;
                return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            }

            function showNotification(message, type = 'success') {
                UI.notificationText.textContent = message;
                UI.notificationIcon.className = `fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'}`;
                UI.notification.className = `notification show ${type}`;
                setTimeout(() => UI.notification.classList.remove('show'), 4000);
            }
            
            function initIntersectionObserver() {
                const observer = new IntersectionObserver((entries) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            entry.target.classList.add('visible');
                            observer.unobserve(entry.target);
                        }
                    });
                }, { threshold: 0.1 });
                document.querySelectorAll('.animate-on-scroll').forEach(el => observer.observe(el));
            }

            fetchData();
        });
    </script>
</body>
</html>
