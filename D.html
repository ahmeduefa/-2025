<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>خريطة المستشفيات</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- jQuery + DataTables -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css"/>
  <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body { font-family: Tahoma, Arial, sans-serif; margin:0; padding:0; background:#f9f9f9; }
    header { background:#007e3a; color:#fff; text-align:center; padding:15px; font-size:1.3em; }
    #map { width:100%; height:350px; }
    .container { padding:15px; }
    table { width:100%; border-collapse:collapse; background:#fff; border-radius:8px; overflow:hidden; }
    th, td { padding:10px; border:1px solid #ddd; font-size:14px; }
    th { background:#007e3a; color:#fff; }
    tr:nth-child(even) { background:#f2f2f2; }
    .stats { display:flex; flex-wrap:wrap; gap:10px; margin-bottom:15px; }
    .stat { flex:1; min-width:120px; background:#fff; padding:10px; border-radius:8px; text-align:center; box-shadow:0 2px 5px rgba(0,0,0,0.1); }
    #charts { display:flex; flex-wrap:wrap; gap:15px; margin-top:20px; }
    #charts canvas { flex:1; min-width:250px; max-width:100%; background:#fff; padding:10px; border-radius:8px; }
    .btn-details { padding:4px 8px; background:#007e3a; color:#fff; border:none; border-radius:4px; cursor:pointer; }
    #details-modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); align-items:center; justify-content:center; }
    #details-modal .modal-content { background:#fff; padding:20px; border-radius:10px; width:90%; max-width:500px; }
    #close-modal { float:left; cursor:pointer; color:#f00; }
  </style>
</head>
<body>

<header>خريطة المستشفيات</header>
<div id="map"></div>

<div class="container">
  <div class="stats">
    <div class="stat"><div>إجمالي المستشفيات</div><div id="stat-total">0</div></div>
    <div class="stat"><div>عدد الأسرة</div><div id="stat-beds">0</div></div>
    <div class="stat"><div>أسرة العناية</div><div id="stat-icu">0</div></div>
    <div class="stat"><div>القطاع الخاص</div><div id="stat-private">0</div></div>
  </div>

  <input type="text" id="search-input" placeholder="ابحث عن مستشفى..." style="margin-bottom:10px; padding:5px; width:100%; max-width:300px;">
  <table id="hospital-table">
    <thead>
      <tr>
        <th>الاسم</th>
        <th>المحافظة</th>
        <th>النوع</th>
        <th>الجهة</th>
        <th>الأسرة</th>
        <th>العناية</th>
        <th>تفاصيل</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div id="charts">
    <canvas id="chart-type"></canvas>
    <canvas id="chart-supervisor"></canvas>
  </div>
</div>

<!-- Modal -->
<div id="details-modal">
  <div class="modal-content">
    <span id="close-modal">✖</span>
    <h3 id="modal-hospital-name"></h3>
    <div id="modal-content-body"></div>
  </div>
</div>

<script>
let hospitals = [];
let map;
let dataTable;
let chartType, chartSupervisor;

// تحميل البيانات من Google Sheets CSV
async function loadHospitals(){
  const url = "https://docs.google.com/spreadsheets/d/e/2PACX-1vR6OX3acZw-8gzNb36iUGra5OI-7TQmhEeZTxpoyyPO1kdYNlycokRPa4FWf9pY6CRRRu9fl0SHhBVZ/pub?gid=0&single=true&output=csv";
  const res = await fetch(url);
  const text = await res.text();
  const rows = text.trim().split("\n").map(r=>r.split(","));
  const headers = rows[0];
  hospitals = rows.slice(1).map(r=>({
    name: r[0],
    city: r[1],
    type: r[2],
    supervisor: r[3],
    beds: +r[4] || 0,
    icu: +r[5] || 0,
    lat: +r[6],
    lng: +r[7],
    googleMaps: r[8]
  }));
  init();
}

function init(){
  // خريطة
  map = L.map('map').setView([24,45], 5);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

  hospitals.forEach(h=>{
    if(!h.lat || !h.lng) return;
    L.marker([h.lat,h.lng]).addTo(map).bindPopup(`<b>${h.name}</b><br>${h.city}`);
  });

  // جدول
  dataTable = $('#hospital-table').DataTable({
    data: hospitals,
    columns:[
      {data:"name"},
      {data:"city"},
      {data:"type"},
      {data:"supervisor"},
      {data:"beds"},
      {data:"icu"},
      {
        data:null,
        render:d=>`<button class="btn-details" data-name="${d.name}">عرض</button>`
      }
    ]
  });

  // إحصائيات
  updateStatsDisplay();

  // Charts
  initCharts();

  // بحث
  $('#search-input').on('keyup', function(){
    dataTable.search(this.value).draw();
  });

  // تفاصيل
  $(document).on('click','.btn-details', function(){
    const name = $(this).data('name');
    const h = hospitals.find(x=>x.name===name);
    $('#modal-hospital-name').text(h.name);
    $('#modal-content-body').html(`
      <p><b>المحافظة:</b> ${h.city}</p>
      <p><b>النوع:</b> ${h.type}</p>
      <p><b>الجهة:</b> ${h.supervisor}</p>
      <p><b>الأسرة:</b> ${h.beds}</p>
      <p><b>العناية:</b> ${h.icu}</p>
      <p><a href="${h.googleMaps}" target="_blank">فتح في Google Maps</a></p>
    `);
    $('#details-modal').fadeIn();
  });

  $('#close-modal').on('click', ()=> $('#details-modal').fadeOut());
  $('#details-modal').on('click', e=>{ if(e.target.id==="details-modal") $('#details-modal').fadeOut(); });
}

function updateStatsDisplay(){
  const total = hospitals.length;
  const totalBeds = hospitals.reduce((a,b)=>a+b.beds,0);
  const totalIcu = hospitals.reduce((a,b)=>a+b.icu,0);
  const privateCount = hospitals.filter(h=>h.type==="خاص").length;
  $('#stat-total').text(total);
  $('#stat-beds').text(totalBeds);
  $('#stat-icu').text(totalIcu);
  $('#stat-private').text(privateCount);
}

function initCharts(){
  const ctx1 = document.getElementById('chart-type').getContext('2d');
  const ctx2 = document.getElementById('chart-supervisor').getContext('2d');

  const typeCounts = {};
  const supCounts = {};
  hospitals.forEach(h=>{
    typeCounts[h.type] = (typeCounts[h.type]||0)+1;
    supCounts[h.supervisor] = (supCounts[h.supervisor]||0)+1;
  });

  chartType = new Chart(ctx1,{
    type:'pie',
    data:{
      labels:Object.keys(typeCounts),
      datasets:[{data:Object.values(typeCounts), backgroundColor:["#007e3a","#f39c12","#3498db","#e74c3c"]}]
    }
  });

  chartSupervisor = new Chart(ctx2,{
    type:'bar',
    data:{
      labels:Object.keys(supCounts),
      datasets:[{data:Object.values(supCounts), backgroundColor:"#007e3a"}]
    },
    options:{plugins:{legend:{display:false}}}
  });
}

loadHospitals();
</script>

</body>
</html>
