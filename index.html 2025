<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام إدارة المستشفيات - تجمع عسير الصحي</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        :root {
            --moh-green: #007e3a;
            --moh-light-green: #e0f2e6;
            --moh-dark-green: #00612d;
            --moh-gold: #d4af37;
            --moh-white: #ffffff;
            --moh-light-gray: #f5f5f5;
            --moh-text: #333333;
        }
        body {
            background-color: var(--moh-light-gray);
            color: var(--moh-text);
            min-height: 100vh;
            padding: 15px;
            line-height: 1.6;
        }
        .container { max-width: 1400px; margin: 0 auto; }
        header {
            background: linear-gradient(135deg, var(--moh-green), var(--moh-dark-green));
            color: var(--moh-white);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.15);
            text-align: center;
            animation: fadeIn 1s ease;
        }
        .logo-container { display: flex; align-items: center; justify-content: center; gap: 15px; margin-bottom: 15px; }
        .logo {
            width: 70px; height: 70px; background-color: var(--moh-white);
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-size: 30px; color: var(--moh-green); box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        h1 { font-size: 1.8rem; margin-bottom: 10px; }
        p.subtitle { font-size: 1rem; opacity: 0.9; max-width: 800px; margin: 0 auto; }
        .dashboard { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 25px; }
        .card {
            background: var(--moh-white); border-radius: 12px; overflow: hidden;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            opacity: 0; transform: translateY(20px);
        }
        .card.visible { opacity: 1; transform: translateY(0); }
        .card:hover { transform: translateY(-5px); box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15); }
        .card-header {
            background: linear-gradient(135deg, var(--moh-green), var(--moh-dark-green));
            color: var(--moh-white); padding: 15px 20px; font-size: 1.1rem;
            font-weight: bold; display: flex; align-items: center; gap: 10px;
        }
        .card-body { padding: 20px; height: 400px; }
        .map-container { height: 100%; position: relative; }
        #hospitals-map { width: 100%; height: 100%; border-radius: 8px; z-index: 1; }
        .stats-container { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; height: 280px; overflow-y: auto; padding: 5px; }
        .stat-card {
            background: linear-gradient(135deg, var(--moh-green), var(--moh-dark-green));
            color: var(--moh-white); padding: 15px; border-radius: 8px; text-align: center;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.1); transition: transform 0.3s ease;
            cursor: pointer; display: flex; flex-direction: column; align-items: center;
            justify-content: center; min-height: 120px;
        }
        .stat-card:hover { transform: translateY(-3px); }
        .stat-icon {
            font-size: 1.8rem; margin-bottom: 8px; background: rgba(255, 255, 255, 0.2);
            width: 50px; height: 50px; border-radius: 50%; display: flex;
            align-items: center; justify-content: center;
        }
        .stat-number { font-size: 1.5rem; font-weight: bold; margin-bottom: 5px; min-height: 30px; }
        .stat-label { font-size: 0.85rem; opacity: 0.9; }
        button, .action-btn {
            background: var(--moh-green); border: none; color: var(--moh-white);
            padding: 10px 15px; border-radius: 6px; cursor: pointer;
            transition: background 0.3s, transform 0.2s; display: flex;
            align-items: center; gap: 8px; font-size: 0.9rem; text-decoration: none;
        }
        button:hover, .action-btn:hover { background: var(--moh-dark-green); transform: translateY(-2px); }
        .data-section { margin-top: 25px; animation: fadeIn 1.5s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .filters { display: flex; gap: 12px; margin-bottom: 20px; flex-wrap: wrap; }
        select, input {
            padding: 10px 12px; border-radius: 6px; border: 1px solid #ddd;
            min-width: 150px; flex: 1; background-color: var(--moh-white);
            font-size: 0.9rem; transition: border-color 0.3s, box-shadow 0.3s;
        }
        select:focus, input:focus { border-color: var(--moh-green); box-shadow: 0 0 0 2px rgba(0, 126, 58, 0.2); outline: none; }
        .table-container { overflow-x: auto; border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); }
        table { width: 100%; border-collapse: collapse; background: var(--moh-white); min-width: 600px; }
        th, td { padding: 12px 15px; text-align: right; border-bottom: 1px solid #e0e0e0; font-size: 0.9rem; }
        th {
            background: linear-gradient(135deg, var(--moh-green), var(--moh-dark-green));
            color: var(--moh-white); font-weight: bold; position: sticky; top: 0; z-index: 2;
        }
        tr:hover { background-color: var(--moh-light-green); }
        footer { text-align: center; padding: 20px; margin-top: 40px; color: var(--moh-green); font-size: 0.9rem; }
        .modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.6); z-index: 1000; justify-content: center; align-items: center;
        }
        .modal-content {
            background-color: var(--moh-white); padding: 25px 30px; border-radius: 12px;
            width: 90%; max-width: 600px; max-height: 90vh; overflow-y: auto;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2); animation: scaleIn 0.4s ease-out;
        }
        @keyframes scaleIn { from { transform: scale(0.8) translateY(20px); opacity: 0; } to { transform: scale(1) translateY(0); opacity: 1; } }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid #eee; }
        .modal-title { font-size: 1.5rem; color: var(--moh-dark-green); font-weight: 600; }
        .close-btn { background: #f1f1f1; border: none; font-size: 1.2rem; cursor: pointer; color: #555; width: 30px; height: 30px; border-radius: 50%; transition: all 0.3s; }
        .close-btn:hover { background: #e0e0e0; color: black; }
        .detail-group { margin-bottom: 20px; }
        .detail-group-title { font-weight: bold; color: var(--moh-green); margin-bottom: 12px; border-bottom: 2px solid var(--moh-light-green); padding-bottom: 5px; }
        .detail-item { margin-bottom: 12px; display: flex; align-items: center; font-size: 1rem; }
        .detail-item-icon { color: var(--moh-green); min-width: 30px; font-size: 1.1rem; }
        .detail-label { font-weight: bold; color: #555; margin-left: 5px; }
        .action-buttons { display: flex; gap: 15px; margin-top: 25px; flex-wrap: wrap; }
        .btn-primary { background-color: var(--moh-green); }
        .btn-secondary { background-color: var(--moh-gold); color: var(--moh-dark-green); }
        .loading {
            width: 24px; height: 24px; border: 3px solid rgba(0, 126, 58, 0.3);
            border-radius: 50%; border-top-color: var(--moh-green);
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .notification {
            position: fixed; bottom: 20px; right: 20px; padding: 15px 20px;
            background-color: var(--moh-green); color: white; border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); transform: translateY(120%);
            opacity: 0; transition: transform 0.4s, opacity 0.4s; z-index: 2000;
        }
        .notification.show { transform: translateY(0); opacity: 1; }
        .user-location-section { background-color: var(--moh-white); border-radius: 12px; padding: 20px; margin-bottom: 25px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); }
        .user-location-header { display: flex; align-items: center; gap: 10px; margin-bottom: 15px; color: var(--moh-green); }
        .user-location-content { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .location-info, .closest-hospital-info { padding: 15px; background-color: var(--moh-light-green); border-radius: 8px; }
        #closest-hospital-data .info-item { margin-bottom: 8px; }
        .loader { display: flex; justify-content: center; align-items: center; height: 200px; flex-direction: column; gap: 15px; }
        .loader-text { color: var(--moh-green); font-weight: bold; }
        .back-to-top {
            position: fixed; bottom: 30px; left: 30px; width: 50px; height: 50px;
            background-color: var(--moh-green); color: white; border-radius: 50%;
            display: flex; align-items: center; justify-content: center; font-size: 20px;
            cursor: pointer; opacity: 0; visibility: hidden; transition: all 0.3s ease;
            z-index: 999; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        .back-to-top.visible { opacity: 1; visibility: visible; }
        .leaflet-div-icon { border: none; background-color: transparent; }
        .map-marker {
            width: 30px; height: 30px; border-radius: 50% 50% 50% 0;
            transform: rotate(-45deg); display: flex; align-items: center; justify-content: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.4); border: 2px solid white;
        }
        .map-marker i { transform: rotate(45deg); font-size: 14px; color: white; }
        .legend {
            padding: 10px; background: white; border-radius: 5px; box-shadow: 0 1px 5px rgba(0,0,0,0.4);
            line-height: 1.5; font-size: 12px;
        }
        .legend i { width: 18px; height: 18px; float: right; margin-left: 8px; border-radius: 50%; }
        
        @media (max-width: 992px) {
            .dashboard { grid-template-columns: 1fr; }
            h1 { font-size: 1.5rem; }
        }
        @media (max-width: 768px) {
            body { padding: 10px; }
            .user-location-content { grid-template-columns: 1fr; }
            .filters { flex-direction: column; }
            .card-body { height: 350px; }
            th:nth-child(5), td:nth-child(5), th:nth-child(7), td:nth-child(7) { display: none; }
        }
        @media (max-width: 480px) {
            h1 { font-size: 1.2rem; }
            .logo { width: 50px; height: 50px; font-size: 24px;}
            .card-body { height: 300px; }
            .stats-container { grid-template-columns: 1fr; height: auto; }
            th:nth-child(4), td:nth-child(4) { display: none; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo-container">
                <div class="logo"><i class="fas fa-hospital"></i></div>
                <div>
                    <h1>نظام إدارة المستشفيات - تجمع عسير الصحي</h1>
                    <p class="subtitle">منصة متكاملة لعرض بيانات المستشفيات والمراكز الصحية في منطقة عسير</p>
                </div>
            </div>
        </header>

        <div class="user-location-section">
            <div class="user-location-header"><i class="fas fa-map-marker-alt"></i><h2>الموقع الحالي وأقرب مستشفى</h2></div>
            <div class="user-location-content">
                <div class="location-info">
                    <h3><i class="fas fa-location-dot"></i> موقعك الحالي</h3>
                    <div>خط العرض: <span id="current-lat">--</span></div>
                    <div>خط الطول: <span id="current-lng">--</span></div>
                    <div>الدقة: <span id="current-accuracy">--</span></div>
                    <button id="get-location-btn"><i class="fas fa-location-crosshairs"></i> تحديث الموقع</button>
                </div>
                <div class="closest-hospital-info">
                    <h3><i class="fas fa-hospital"></i> أقرب مستشفى إليك</h3>
                    <div id="closest-hospital-data">جاري تحميل البيانات...</div>
                </div>
            </div>
        </div>

        <div class="dashboard">
            <div class="card">
                <div class="card-header"><i class="fas fa-map-marked-alt"></i><span>الخريطة التفاعلية</span></div>
                <div class="card-body"><div id="hospitals-map"></div></div>
            </div>
            <div class="card">
                <div class="card-header"><i class="fas fa-chart-bar"></i><span>إحصائيات عامة</span></div>
                <div class="card-body">
                    <div class="stats-container">
                        <div class="stat-card" id="total-hospitals"><div class="stat-icon"><i class="fas fa-hospital"></i></div><div class="stat-number">0</div><div class="stat-label">عدد المستشفيات</div></div>
                        <div class="stat-card" id="total-beds"><div class="stat-icon"><i class="fas fa-bed"></i></div><div class="stat-number">0</div><div class="stat-label">إجمالي الأسرة</div></div>
                        <div class="stat-card" id="total-icu"><div class="stat-icon"><i class="fas fa-procedures"></i></div><div class="stat-number">0</div><div class="stat-label">أسرة العناية المركزة</div></div>
                        <div class="stat-card" id="private-hospitals"><div class="stat-icon"><i class="fas fa-stethoscope"></i></div><div class="stat-number">0</div><div class="stat-label">مستشفى خاص</div></div>
                        <div class="stat-card" id="general-hospitals"><div class="stat-icon"><i class="fas fa-clinic-medical"></i></div><div class="stat-number">0</div><div class="stat-label">مستشفى عام</div></div>
                        <div class="stat-card" id="specialized-hospitals"><div class="stat-icon"><i class="fas fa-heartbeat"></i></div><div class="stat-number">0</div><div class="stat-label">مستشفى متخصص</div></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="data-section">
            <div class="filters">
                <select id="filter-type"><option value="">جميع الأنواع</option></select>
                <select id="filter-supervisor"><option value="">جميع الجهات المشرفة</option></select>
                <input type="text" id="search-input" placeholder="ابحث باسم المستشفى أو المحافظة...">
            </div>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>#</th><th>اسم المستشفى</th><th>المحافظة</th><th>النوع</th><th>الجهة المشرفة</th>
                            <th>عدد الأسرة</th><th>أسرة العناية</th><th>المسافة</th><th>التفاصيل</th>
                        </tr>
                    </thead>
                    <tbody id="hospitals-table">
                        <tr><td colspan="9"><div class="loader"><div class="loading"></div><div class="loader-text">جاري تحميل البيانات...</div></div></td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <footer><p>© 2024 وزارة الصحة - المملكة العربية السعودية. جميع الحقوق محفوظة.</p></footer>
    </div>

    <div class="back-to-top" id="back-to-top"><i class="fas fa-arrow-up"></i></div>

    <div class="modal" id="details-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modal-hospital-name"></h2>
                <button class="close-btn" id="close-modal">×</button>
            </div>
            <div id="modal-content-body"></div>
        </div>
    </div>

    <div class="notification" id="notification"><i class="fas fa-check-circle"></i><span id="notification-text"></span></div>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            let hospitals = [];
            let userLocation = null;
            let map;
            let legend;
            const hospitalMarkers = L.layerGroup();

            const UI = {
                loaderText: document.querySelector('#hospitals-table .loader-text'),
                tableBody: document.getElementById('hospitals-table'),
                mapContainer: 'hospitals-map',
                lat: document.getElementById('current-lat'),
                lng: document.getElementById('current-lng'),
                accuracy: document.getElementById('current-accuracy'),
                closestHospital: document.getElementById('closest-hospital-data'),
                notification: document.getElementById('notification'),
                notificationText: document.getElementById('notification-text'),
                modal: document.getElementById('details-modal'),
                modalTitle: document.getElementById('modal-hospital-name'),
                modalBody: document.getElementById('modal-content-body'),
                typeFilter: document.getElementById('filter-type'),
                supervisorFilter: document.getElementById('filter-supervisor'),
                searchInput: document.getElementById('search-input'),
                backToTop: document.getElementById('back-to-top')
            };

            const DATA_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vR6OX3acZw-8gzNb36iUGra5OI-7TQmhEeZTxpoyyPO1kdYNlycokRPa4FWf9pY6CRRRu9fl0SHhBVZ/pub?gid=0&single=true&output=csv";

            async function fetchData() {
                try {
                    const response = await fetch(DATA_URL, { cache: 'no-store' });
                    if (!response.ok) throw new Error(`Network error: ${response.statusText}`);
                    const csvText = await response.text();
                    const results = Papa.parse(csvText, { header: true, skipEmptyLines: true, transformHeader: h => h.trim() });
                    if (results.errors.length) throw new Error(`Parsing error: ${results.errors[0].message}`);
                    hospitals = results.data.map((row, i) => ({
                        id: i, name: row['أسم المستشفى'] || 'N/A', city: row['المحافظة'] || 'N/A',
                        supervisor: row['الجهة المشرفة'] || 'N/A', type: row['نوع المستشفى'] || 'N/A',
                        beds: parseInt(row['عدد أسرة التنويم']) || 0, icu: parseInt(row['عدد اسرة العناية المركزة كبار']) || 0,
                        lat: parseFloat(row['Latitude']), lng: parseFloat(row['Longitude']),
                        googleMaps: row['موقع المنشأة في قوقل ماب']
                    })).filter(h => h.lat && h.lng && h.name !== 'N/A');
                    if (hospitals.length === 0) throw new Error("No valid data found in the sheet.");
                    initializeApp();
                    showNotification(`تم تحميل ${hospitals.length} مستشفى بنجاح`, 'success');
                } catch (error) {
                    console.error("Fetch Data Error:", error);
                    UI.loaderText.textContent = `❌ فشل تحميل البيانات: ${error.message}`;
                    showNotification("فشل في جلب البيانات. تحقق من الرابط وإعدادات النشر.", 'error');
                }
            }

            function initializeApp() {
                initMap();
                addMapLegend();
                populateFilters();
                updateStats();
                renderTable(hospitals);
                getUserLocation();
                addEventListeners();
                document.querySelectorAll('.card').forEach((card, i) => setTimeout(() => card.classList.add('visible'), 100 * i));
            }

            function initMap() {
                map = L.map(UI.mapContainer).setView([18.5, 42.5], 8);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '© OpenStreetMap' }).addTo(map);
                hospitalMarkers.addTo(map);
            }

            function getMarkerStyle(hospitalType) {
                switch (hospitalType) {
                    case 'عام': return { color: '#007bff', icon: 'fa-hospital' };
                    case 'متخصصة': return { color: '#dc3545', icon: 'fa-heart-pulse' };
                    case 'مركزية': return { color: '#28a745', icon: 'fa-star-of-life' };
                    case 'خاص': return { color: '#ffc107', icon: 'fa-clinic-medical' };
                    default: return { color: '#6c757d', icon: 'fa-h-square' };
                }
            }

            function renderMapMarkers(data) {
                hospitalMarkers.clearLayers();
                data.forEach(h => {
                    const style = getMarkerStyle(h.type);
                    const icon = L.divIcon({
                        className: 'leaflet-div-icon',
                        html: `<div class="map-marker" style="background-color: ${style.color};"><i class="fas ${style.icon}"></i></div>`,
                        iconSize: [30, 42], iconAnchor: [15, 42]
                    });
                    const marker = L.marker([h.lat, h.lng], { icon: icon }).bindPopup(`<b>${h.name}</b><br>${h.type}`);
                    hospitalMarkers.addLayer(marker);
                });
            }

            function addMapLegend() {
                if (legend) map.removeControl(legend);
                legend = L.control({ position: 'bottomright' });
                legend.onAdd = function (map) {
                    const div = L.DomUtil.create('div', 'legend');
                    const types = {'عام': getMarkerStyle('عام'), 'متخصصة': getMarkerStyle('متخصصة'), 'مركزية': getMarkerStyle('مركزية'), 'خاص': getMarkerStyle('خاص'), 'أخرى': getMarkerStyle('default')};
                    div.innerHTML += '<h4>أنواع المستشفيات</h4>';
                    for (let key in types) { div.innerHTML += `<i style="background: ${types[key].color}"></i> ${key}<br>`; }
                    return div;
                };
                legend.addTo(map);
            }

            function populateFilters() {
                const types = [...new Set(hospitals.map(h => h.type))];
                const supervisors = [...new Set(hospitals.map(h => h.supervisor))];
                UI.typeFilter.innerHTML = '<option value="">جميع الأنواع</option>' + types.map(t => `<option value="${t}">${t}</option>`).join('');
                UI.supervisorFilter.innerHTML = '<option value="">جميع الجهات</option>' + supervisors.map(s => `<option value="${s}">${s}</option>`).join('');
            }
            
            function renderTable(data) {
                UI.tableBody.innerHTML = '';
                if (!data.length) {
                    UI.tableBody.innerHTML = '<tr><td colspan="9" style="text-align:center;">لا توجد نتائج مطابقة</td></tr>';
                    renderMapMarkers([]);
                    return;
                }
                const rows = data.map((h, i) => `
                    <tr>
                        <td>${i + 1}</td><td>${h.name}</td><td>${h.city}</td><td class="col-type">${h.type}</td><td class="col-supervisor">${h.supervisor}</td>
                        <td>${h.beds}</td><td class="col-icu">${h.icu}</td>
                        <td>${h.distance ? `${h.distance} كم` : '--'}</td>
                        <td><button class="details-btn" data-id="${h.id}"><i class="fas fa-info-circle"></i></button></td>
                    </tr>`).join('');
                UI.tableBody.innerHTML = rows;
                renderMapMarkers(data);
            }
            
            function updateStats() {
                const stats = {
                    total: hospitals.length, beds: hospitals.reduce((sum, h) => sum + h.beds, 0),
                    icu: hospitals.reduce((sum, h) => sum + h.icu, 0), private: hospitals.filter(h => h.supervisor === "القطاع الخاص").length,
                    general: hospitals.filter(h => h.type === "عام").length, specialized: hospitals.filter(h => h.type === "متخصصة" || h.type === "مركزية").length,
                };
                document.querySelector('#total-hospitals .stat-number').textContent = stats.total;
                document.querySelector('#total-beds .stat-number').textContent = stats.beds.toLocaleString();
                document.querySelector('#total-icu .stat-number').textContent = stats.icu.toLocaleString();
                document.querySelector('#private-hospitals .stat-number').textContent = stats.private;
                document.querySelector('#general-hospitals .stat-number').textContent = stats.general;
                document.querySelector('#specialized-hospitals .stat-number').textContent = stats.specialized;
            }

            function getUserLocation() {
                if (!navigator.geolocation) return;
                navigator.geolocation.getCurrentPosition(pos => {
                    userLocation = { lat: pos.coords.latitude, lng: pos.coords.longitude };
                    UI.lat.textContent = userLocation.lat.toFixed(5);
                    UI.lng.textContent = userLocation.lng.toFixed(5);
                    UI.accuracy.textContent = `${Math.round(pos.coords.accuracy)} م`;
                    updateDistances();
                }, () => showNotification("لا يمكن الوصول لموقعك.", 'error'));
            }

            function updateDistances() {
                if (!userLocation) return;
                let closest = { dist: Infinity, hospital: null };
                hospitals.forEach(h => {
                    h.distance = haversine(userLocation.lat, userLocation.lng, h.lat, h.lng);
                    if (h.distance < closest.dist) closest = { dist: h.distance, hospital: h };
                });
                hospitals.sort((a, b) => a.distance - b.distance);
                filterAndRender();
                if (closest.hospital) {
                    UI.closestHospital.innerHTML = `
                        <div class="info-item"><strong>الاسم:</strong> ${closest.hospital.name}</div>
                        <div class="info-item"><strong>النوع:</strong> ${closest.hospital.type} - ${closest.hospital.city}</div>
                        <div class="info-item"><strong>المسافة:</strong> ${closest.dist} كم</div>
                        <a href="${closest.hospital.googleMaps}" target="_blank" class="action-btn" style="margin-top: 10px; width: 100%; justify-content: center;">
                            <i class="fas fa-map-marked-alt"></i> الانتقال للموقع
                        </a>
                    `;
                }
            }

            function haversine(lat1, lon1, lat2, lon2) {
                const R = 6371, dLat = (lat2 - lat1) * Math.PI / 180, dLon = (lon2 - lon1) * Math.PI / 180;
                const a = Math.sin(dLat / 2) ** 2 + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon / 2) ** 2;
                return parseFloat((R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a))).toFixed(1));
            }

            function filterAndRender() {
                const type = UI.typeFilter.value;
                const supervisor = UI.supervisorFilter.value;
                const search = UI.searchInput.value.toLowerCase();
                const filtered = hospitals.filter(h =>
                    (type === '' || h.type === type) && (supervisor === '' || h.supervisor === supervisor) &&
                    (h.name.toLowerCase().includes(search) || h.city.toLowerCase().includes(search))
                );
                renderTable(filtered);
            }

            function showDetails(id) {
                const h = hospitals.find(h => h.id === id);
                if (!h) return;
                UI.modalTitle.textContent = h.name;
                const directionsUrl = userLocation ? `https://www.google.com/maps/dir/?api=1&origin=${userLocation.lat},${userLocation.lng}&destination=${h.lat},${h.lng}` : h.googleMaps;

                UI.modalBody.innerHTML = `
                    <div class="detail-group">
                        <div class="detail-group-title">معلومات عامة</div>
                        <div class="detail-item"><i class="fas fa-city detail-item-icon"></i><span class="detail-label">المحافظة:</span> ${h.city}</div>
                        <div class="detail-item"><i class="fas fa-sitemap detail-item-icon"></i><span class="detail-label">النوع:</span> ${h.type}</div>
                        <div class="detail-item"><i class="fas fa-building-user detail-item-icon"></i><span class="detail-label">الجهة المشرفة:</span> ${h.supervisor}</div>
                    </div>
                    <div class="detail-group">
                        <div class="detail-group-title">السعة السريرية</div>
                        <div class="detail-item"><i class="fas fa-bed-pulse detail-item-icon"></i><span class="detail-label">عدد الأسرة:</span> ${h.beds}</div>
                        <div class="detail-item"><i class="fas fa-procedures detail-item-icon"></i><span class="detail-label">أسرة العناية:</span> ${h.icu}</div>
                    </div>
                     ${h.distance ? `<div class="detail-group">
                        <div class="detail-group-title">المسافة</div>
                        <div class="detail-item"><i class="fas fa-route detail-item-icon"></i><span class="detail-label">المسافة منك:</span> ${h.distance} كم</div>
                    </div>` : ''}
                    <div class="action-buttons">
                        <a href="${h.googleMaps}" target="_blank" class="action-btn btn-primary"><i class="fas fa-map-marked-alt"></i> عرض على الخريطة</a>
                        <a href="${directionsUrl}" target="_blank" class="action-btn btn-secondary"><i class="fas fa-directions"></i> اتجاهات السير</a>
                    </div>
                `;
                UI.modal.style.display = 'flex';
            }

            function showNotification(message, type = 'success') {
                UI.notificationText.textContent = message;
                UI.notification.style.backgroundColor = type === 'error' ? '#c82333' : 'var(--moh-green)';
                UI.notification.classList.add('show');
                setTimeout(() => UI.notification.classList.remove('show'), 4000);
            }

            function addEventListeners() {
                UI.typeFilter.addEventListener('change', filterAndRender);
                UI.supervisorFilter.addEventListener('change', filterAndRender);
                UI.searchInput.addEventListener('input', filterAndRender);
                document.getElementById('get-location-btn').addEventListener('click', getUserLocation);
                UI.modal.addEventListener('click', e => { if (e.target === UI.modal || e.target.id === 'close-modal' || e.target.closest('.close-btn')) UI.modal.style.display = 'none'; });
                UI.tableBody.addEventListener('click', e => {
                    const btn = e.target.closest('.details-btn');
                    if (btn) showDetails(parseInt(btn.dataset.id));
                });
                window.addEventListener('scroll', () => UI.backToTop.classList.toggle('visible', window.pageYOffset > 300));
                UI.backToTop.addEventListener('click', () => window.scrollTo({ top: 0, behavior: 'smooth' }));
            }

            fetchData();
        });
    </script>
</body>
</html>
